<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Detection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-brain"></i>
            </div>
            <h1>Emotion Detection</h1>
            <p class="subtitle">Upload an image or use your webcam. Backend classes: angry, happy, neutral.</p>
        </header>

        <div class="tabs">
            <button class="tab-btn active" id="tabUpload">Upload</button>
            <button class="tab-btn" id="tabWebcam">Webcam</button>
        </div>

        <div class="app-container">
            <div class="card" id="uploadCard">
                <h2 class="card-title">
                    <i class="fas fa-file-upload"></i>
                    Upload Image
                </h2>
                <div class="input-section">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div class="upload-text">Drag & Drop or Click to Upload</div>
                            <div class="upload-hint">JPG, PNG, WEBP, GIF (Max 5MB)</div>
                        </div>
                        <div class="preview-container" id="previewContainer">
                            <img id="previewImage" class="preview-image" src="" alt="Preview">
                            <canvas id="previewCanvas" class="preview-canvas"></canvas>
                        </div>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept=".png,.jpg,.jpeg,.webp,.gif">
                    <button class="btn" id="analyzeBtn">
                        <i class="fas fa-search"></i>
                        Analyze Emotion
                    </button>
                </div>
                <div class="alert alert-error" id="errorAlert"></div>
                <div class="loading" id="uploadLoading">
                    <div class="spinner"></div>
                    <p>Analyzing image...</p>
                </div>
                <div class="results-section" id="uploadResults"></div>
            </div>

            <div class="card" id="webcamCard" style="display:none;">
                <h2 class="card-title">
                    <i class="fas fa-camera"></i>
                    Live Webcam
                </h2>
                <div class="input-section">
                    <div class="webcam-container">
                        <video id="videoElement" autoplay playsinline></video>
                    </div>
                    <div class="webcam-controls">
                        <button class="btn" id="startWebcamBtn">
                            <i class="fas fa-play"></i>
                            Start Webcam
                        </button>
                        <button class="btn btn-secondary" id="captureBtn" disabled>
                            <i class="fas fa-camera"></i>
                            Capture & Analyze
                        </button>
                    </div>
                </div>
                <div class="loading" id="webcamLoading">
                    <div class="spinner"></div>
                    <p>Analyzing capture...</p>
                </div>
                <div class="results-section" id="webcamResults"></div>
            </div>
        </div>

        <footer>
            <p>Flask + TensorFlow + MediaPipe</p>
        </footer>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const previewCanvas = document.getElementById('previewCanvas');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const errorAlert = document.getElementById('errorAlert');
        const uploadLoading = document.getElementById('uploadLoading');
        const uploadResults = document.getElementById('uploadResults');

        const startWebcamBtn = document.getElementById('startWebcamBtn');
        const captureBtn = document.getElementById('captureBtn');
        const videoElement = document.getElementById('videoElement');
        const webcamLoading = document.getElementById('webcamLoading');
        const webcamResults = document.getElementById('webcamResults');
        const tabUpload = document.getElementById('tabUpload');
        const tabWebcam = document.getElementById('tabWebcam');
        const uploadCard = document.getElementById('uploadCard');
        const webcamCard = document.getElementById('webcamCard');

        let stream = null;

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('upload-area-hover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('upload-area-hover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('upload-area-hover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });

        fileInput.addEventListener('change', handleFileSelect);
        analyzeBtn.addEventListener('click', analyzeImage);
        startWebcamBtn.addEventListener('click', startWebcam);
        captureBtn.addEventListener('click', captureImage);
        tabUpload.addEventListener('click', () => switchTab('upload'));
        tabWebcam.addEventListener('click', () => switchTab('webcam'));

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) return;

            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showError('Please select a valid image file (JPG, PNG, WEBP, GIF)');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                showError('File size must be less than 5MB');
                return;
            }

            hideError();
            previewContainer.style.display = 'block';
            uploadPlaceholder.style.display = 'none';

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                uploadResults.innerHTML = '';
                previewImage.onload = () => resizeCanvasToImage();
            };
            reader.readAsDataURL(file);
        }

        function resizeCanvasToImage() {
            // Match canvas to the upload area's inner box
            const rect = previewImage.getBoundingClientRect();
            previewCanvas.width = rect.width;
            previewCanvas.height = rect.height;
            previewCanvas.style.width = rect.width + 'px';
            previewCanvas.style.height = rect.height + 'px';
            const ctx = previewCanvas.getContext('2d');
            ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        }

        function analyzeImage() {
            if (!fileInput.files.length) {
                showError('Please select an image first');
                return;
            }

            uploadLoading.style.display = 'block';
            analyzeBtn.disabled = true;

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            fetch('/upload', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    uploadLoading.style.display = 'none';
                    analyzeBtn.disabled = false;
                    if (data.success) {
                        displayResults(data.results, uploadResults, previewImage);
                    } else {
                        showError(data.error || 'Analysis failed');
                    }
                })
                .catch(err => {
                    uploadLoading.style.display = 'none';
                    analyzeBtn.disabled = false;
                    showError('Network error: ' + err.message);
                });
        }

        function startWebcam() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(mediaStream) {
                        stream = mediaStream;
                        videoElement.srcObject = stream;
                        startWebcamBtn.disabled = true;
                        captureBtn.disabled = false;
                        webcamResults.innerHTML = '';
                    })
                    .catch(function(error) {
                        showError('Error accessing webcam: ' + error.message);
                    });
            } else {
                showError('Your browser does not support webcam access');
            }
        }

        function captureImage() {
            if (!stream) return;

            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            const imageData = canvas.toDataURL('image/jpeg');

            webcamLoading.style.display = 'block';
            captureBtn.disabled = true;

            fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            })
                .then(r => r.json())
                .then(data => {
                    webcamLoading.style.display = 'none';
                    captureBtn.disabled = false;
                    if (data.success) {
                        const tempImg = new Image();
                        tempImg.src = imageData;
                        tempImg.onload = () => displayResults(data.results, webcamResults, tempImg);
                    } else {
                        showError(data.error || 'Analysis failed');
                    }
                })
                .catch(err => {
                    webcamLoading.style.display = 'none';
                    captureBtn.disabled = false;
                    showError('Network error: ' + err.message);
                });
        }

        function displayResults(results, container, imageElement) {
            container.innerHTML = '';
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="alert alert-error">No faces detected in the image</div>';
                return;
            }

            const result = results[0];
            let emotionClass = 'emotion-neutral';
            if (result.emotion === 'angry') emotionClass = 'emotion-angry';
            if (result.emotion === 'happy') emotionClass = 'emotion-happy';

            const emotionHTML = `
                <div class="emotion-result">
                    <div class="emotion-icon ${emotionClass}">
                        <i class="fas ${result.emotion === 'angry' ? 'fa-angry' : result.emotion === 'happy' ? 'fa-laugh-beam' : 'fa-meh'}"></i>
                    </div>
                    <div class="emotion-details">
                        <div class="emotion-name">${capitalize(result.emotion)}</div>
                        <div class="emotion-confidence">Confidence: ${(result.confidence * 100).toFixed(2)}%</div>
                        <div class="confidence-bar"><div class="confidence-level" style="width: ${result.confidence * 100}%"></div></div>
                    </div>
                </div>`;

            const allEmotionsHTML = `
                <div class="results-title"><i class="fas fa-chart-bar"></i>All Emotion Probabilities</div>
                <div class="all-emotions">
                    ${Object.entries(result.all_predictions).map(([e, p]) => `
                        <div class="emotion-item">
                            <div class="emotion-label">${capitalize(e)}</div>
                            <div class="emotion-percent">${(p * 100).toFixed(1)}%</div>
                        </div>`).join('')}
                </div>`;

            container.innerHTML = emotionHTML + allEmotionsHTML;

            if (result.face_box && imageElement === previewImage) {
                resizeCanvasToImage();
                const [x, y, w, h] = result.face_box;
                const scaleX = imageElement.naturalWidth / imageElement.clientWidth;
                const scaleY = imageElement.naturalHeight / imageElement.clientHeight;
                const ctx = previewCanvas.getContext('2d');
                ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#f72585';
                if (ctx.roundRect) {
                    ctx.beginPath();
                    ctx.roundRect(x / scaleX, y / scaleY, w / scaleX, h / scaleY, 8);
                    ctx.stroke();
                } else {
                    ctx.strokeRect(x / scaleX, y / scaleY, w / scaleX, h / scaleY);
                }
            }
        }

        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
        }

        function hideError() {
            errorAlert.style.display = 'none';
        }

        function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

        function switchTab(which) {
            if (which === 'upload') {
                tabUpload.classList.add('active');
                tabWebcam.classList.remove('active');
                uploadCard.style.display = '';
                webcamCard.style.display = 'none';
            } else {
                tabWebcam.classList.add('active');
                tabUpload.classList.remove('active');
                webcamCard.style.display = '';
                uploadCard.style.display = 'none';
            }
        }

        window.addEventListener('beforeunload', () => {
            if (stream) stream.getTracks().forEach(t => t.stop());
        });
    </script>
</body>
</html>